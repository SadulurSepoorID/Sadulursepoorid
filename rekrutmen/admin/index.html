<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">
  <title>Admin Rekrutmen - Sadulur Sepoor</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-blue: #004aad;
      --secondary-blue: #003075;
      --light-bg: #f4f7fa;
      --text-dark: #32325d;
      --text-muted: #8898aa;
    }
    body { font-family: 'Poppins', sans-serif; background-color: var(--light-bg); color: var(--text-dark); }
    
    .navbar { background: white; box-shadow: 0 2px 15px rgba(0,0,0,0.05); padding: 1rem 0; }
    .navbar-brand { font-weight: 700; color: var(--primary-blue) !important; font-size: 1.2rem; }
    
    .main-card { background: white; border-radius: 16px; border: none; box-shadow: 0 8px 30px rgba(0,0,0,0.04); margin-top: 2rem; overflow: hidden; }
    
    .table thead th { background-color: var(--primary-blue); color: white; font-weight: 600; border: none; padding: 18px; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
    .table tbody td { padding: 18px; vertical-align: middle; border-bottom: 1px solid #f0f2f5; color: #525f7f; font-weight: 500; }
    .table tbody tr:hover { background-color: #f6f9fc; cursor: pointer; transition: all 0.2s; }

    /* Modal Styling */
    .modal-content { border-radius: 20px; border: none; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
    
    .photo-area { 
      background: linear-gradient(135deg, #f6f9fc 0%, #e9ecef 100%);
      text-align: center; padding: 30px; border-bottom: 1px solid #e9ecef;
    }
    
    .detail-img { 
      max-width: 100%; max-height: 350px; width: auto; height: auto; 
      border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); object-fit: contain;
    }

    .detail-section-title {
        font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
        color: var(--primary-blue); margin-top: 20px; margin-bottom: 15px;
        border-bottom: 2px solid #e9ecef; padding-bottom: 5px;
    }

    .detail-item { margin-bottom: 16px; }
    .detail-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .detail-value { font-size: 0.95rem; color: var(--text-dark); font-weight: 500; line-height: 1.4; word-wrap: break-word; }

    /* Status Badge */
    .badge-status { padding: 8px 16px; border-radius: 30px; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; }
    .st-pending { background: #fff8e1; color: #ff9f43; border: 1px solid #ffeeba; }
    .st-admin { background: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; } 
    .st-ok { background: #e0fbf2; color: #2dce89; border: 1px solid #baffeb; }
    .st-fail { background: #fee6e6; color: #f5365c; border: 1px solid #fadbd8; }
    .st-neu { background: #f6f9fc; color: #8898aa; }

    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
  </style>
</head>
<body>

  <div id="loader">
    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
    <div class="fw-bold text-secondary tracking-wide">MEMUAT DATA...</div>
  </div>

  <div id="statusMessage" class="alert position-fixed top-0 end-0 m-3 shadow-sm border-0" style="display: none; z-index: 10000; border-radius: 10px;"></div>

  <nav class="navbar px-4">
    <div class="container-fluid">
      <span class="navbar-brand d-flex align-items-center">
        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width:35px; height:35px; font-size:1rem;">
            <i class="fa-solid fa-train"></i>
        </div>
        Admin Rekrutmen
      </span>
      <button class="btn btn-outline-primary rounded-pill px-4 fw-bold btn-sm" onclick="refreshData()">
        <i class="fa-solid fa-rotate me-1"></i> Refresh
      </button>
    </div>
  </nav>

  <div class="container pb-5">
    <div class="card main-card">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table mb-0" id="mainTable">
            <thead>
              <tr>
                <th width="15%" class="text-center">No Camsas</th>
                <th width="35%">Nama Lengkap</th>
                <th width="20%">Status</th>
                <th width="15%" class="text-center">Skor</th>
                <th width="15%" class="text-end">Aksi</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        
        <div class="modal-header border-0 pb-0 pt-4 px-4 bg-white">
          <div>
              <h4 class="modal-title fw-bold text-dark mb-1">
                  <span id="detailName">Nama Peserta</span>
                  <span id="detailId" class="badge bg-light text-primary border ms-2 fs-6" style="vertical-align: middle;">ID</span>
              </h4>
              <div id="detailStatusBadge" class="mt-2"></div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="background-color: #f0f2f5; border-radius: 50%; padding: 10px;"></button>
        </div>
        
        <div class="modal-body p-0">
          <div class="photo-area mt-3">
             <img id="detailImg" src="" class="detail-img" alt="Foto" referrerpolicy="no-referrer" onerror="this.style.display='none'; document.getElementById('noPhotoMsg').style.display='block';">
             <div id="noPhotoMsg" class="py-4" style="display:none;">
                <div class="text-muted mb-2"><i class="fa-regular fa-image fa-2x"></i></div>
                <span class="text-muted small fw-bold">Pratinjau Tidak Tersedia</span><br>
                <a id="btnOpenLink" href="#" target="_blank" class="btn btn-sm btn-primary mt-2 rounded-pill px-4">
                    Buka Link Asli <i class="fa-solid fa-arrow-up-right-from-square ms-1"></i>
                </a>
             </div>
          </div>

          <div class="px-4 pb-5 pt-2">
            <div class="detail-section-title"><i class="fa-solid fa-address-book me-2"></i> Kontak & Akun</div>
            <div class="row" id="sectionContact"></div>
            
            <div class="detail-section-title"><i class="fa-solid fa-user-shield me-2"></i> Data Pribadi</div>
            <div class="row" id="sectionPersonal"></div>
            
            <div class="detail-section-title"><i class="fa-solid fa-circle-info me-2"></i> Informasi Tambahan</div>
            <div class="row" id="sectionOther"></div>
            
            <div id="sectionMotivationContainer" style="display:none;">
                <div class="detail-section-title"><i class="fa-solid fa-quote-left me-2"></i> Motivasi / Alasan</div>
                <div class="p-3 bg-light rounded text-dark fst-italic border" id="detailMotivation"></div>
            </div>
          </div>
        </div>

        <div class="modal-footer bg-light border-0 px-4 py-3" id="modalFooter">
          <button type="button" class="btn btn-secondary px-4 rounded-pill fw-bold" data-bs-dismiss="modal">Tutup</button>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzlSO03i4xJ6--QmsM6oDfW7fQle_R5zkKMxJFAkz-nTbHW_T-nMzyGFVgQ-6O9dCL7Cw/exec';
    const MIN_SCORE = 60;
    
    let applicantsCache = {}; 
    let detailModalBS = null;

    document.addEventListener("DOMContentLoaded", () => {
      detailModalBS = new bootstrap.Modal(document.getElementById('detailModal'));
      refreshData();
    });

    function refreshData() {
        document.getElementById("loader").style.display = "flex";
        fetch(GAS_API_URL + '?action=getApplicants')
            .then(res => res.json())
            .then(res => {
                if (res.success) renderTable(res.data);
                else showToast(res.message, 'danger');
            })
            .catch(err => showToast('Gagal: ' + err.message, 'danger'))
            .finally(() => document.getElementById("loader").style.display = "none");
    }

    function renderTable(data) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = '';
      applicantsCache = {}; 

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">Belum ada data.</td></tr>';
        return;
      }

      data.reverse().forEach((item, index) => {
        applicantsCache[item.rowNum] = item;
        let s = (item.Status || '').toLowerCase();
        
        let badgeHtml = '';
        if (s === 'pending') {
            badgeHtml = '<span class="badge badge-status st-pending">Menunggu Review</span>';
        } else if (s === 'lolos' || s === 'lolos administrasi') {
            badgeHtml = '<span class="badge badge-status st-admin"><i class="fa-solid fa-check me-1"></i> Lolos Administrasi</span>';
        } else if (s.includes('lolos wawancara')) {
            badgeHtml = '<span class="badge badge-status st-ok"><i class="fa-solid fa-star me-1"></i> Lolos Wawancara</span>';
        } else if (s.includes('gagal')) {
            badgeHtml = '<span class="badge badge-status st-fail">Tidak Lolos</span>';
        } else {
            badgeHtml = `<span class="badge badge-status st-neu">${item.Status}</span>`;
        }

        let score = item["Skor Wawancara"];
        let scoreDisplay = (score && score !== "Belum Dinilai") ? `<span class="fw-bold text-dark">${score}</span>` : `<span class="text-muted small">-</span>`;

        // === PERBAIKAN PENCARIAN ID (NO CAMSAS) ===
        let realId = findCamsasId(item) || "-";

        const tr = document.createElement('tr');
        tr.onclick = () => openDetail(item.rowNum);
        tr.innerHTML = `
            <td class="text-center fw-bold text-primary">${realId}</td>
            <td class="fw-bold text-dark">${item["Nama Lengkap"]}</td>
            <td>${badgeHtml}</td>
            <td class="text-center">${scoreDisplay}</td>
            <td class="text-end"><button class="btn btn-sm btn-outline-primary rounded-pill px-3 fw-bold">Detail</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // FUNGSI BARU: Cari Data yang isinya "Camsas..."
    function findCamsasId(item) {
        // 1. Cek header umum dulu
        if (item["No Camsas"]) return item["No Camsas"];
        if (item["No"]) return item["No"];
        
        // 2. Loop semua value, cari yang teksnya diawali "Camsas"
        for (let key in item) {
            let val = String(item[key]);
            if (val.trim().toLowerCase().startsWith("camsas")) {
                return val;
            }
        }
        return null;
    }

    function openDetail(rowNum) {
        const data = applicantsCache[rowNum];
        if (!data) return;

        let realId = findCamsasId(data) || "-";
        document.getElementById('detailName').innerText = data["Nama Lengkap"];
        document.getElementById('detailId').innerText = realId;
        
        renderPhoto(data);
        renderDetailStatus(data); 

        const sContact = document.getElementById('sectionContact');
        const sPersonal = document.getElementById('sectionPersonal');
        const sOther = document.getElementById('sectionOther');
        const sMotiv = document.getElementById('sectionMotivationContainer');
        
        sContact.innerHTML = ''; sPersonal.innerHTML = ''; sOther.innerHTML = ''; sMotiv.style.display='none';

        const ignoredKeys = ['rowNum', 'Status', 'Nama Lengkap', 'Upload Foto', 'No Camsas', 'No', 'Skor Wawancara'];
        
        Object.keys(data).forEach(key => {
            if (ignoredKeys.includes(key)) return;
            // Skip jika value sama dengan ID (supaya tidak dobel)
            const val = data[key];
            if (val === realId) return; 

            if (typeof val === 'string' && val.includes('drive.google.com')) return; 

            const k = key.toLowerCase();
            if (k.includes('email') || k.includes('wa') || k.includes('hp') || k.includes('telp') || k.includes('sosmed') || k.includes('instagram')) {
                sContact.appendChild(createDetailItem(key, val, 'col-md-6'));
            } else if (k.includes('alamat') || k.includes('lahir') || k.includes('kota') || k.includes('domisili')) {
                sPersonal.appendChild(createDetailItem(key, val, 'col-md-6'));
            } else if (k.includes('alasan') || k.includes('motivasi')) {
                document.getElementById('detailMotivation').innerText = val;
                sMotiv.style.display = 'block';
            } else {
                sOther.appendChild(createDetailItem(key, val, 'col-md-6'));
            }
        });
        
        if (data["Skor Wawancara"] && data["Skor Wawancara"] !== "Belum Dinilai") {
            sOther.appendChild(createDetailItem("Skor Wawancara", data["Skor Wawancara"] + " / 100", 'col-md-6 fw-bold text-primary'));
        }

        setupActionButtons(data);
        detailModalBS.show();
    }

    function createDetailItem(label, value, colClass) {
        let displayVal = value;
        if ((label.toLowerCase().includes('time') || label.toLowerCase().includes('tgl')) && value) {
             try { displayVal = new Date(value).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }); } catch(e){}
        }
        
        let icon = '<i class="fa-solid fa-circle-small me-1"></i>';
        const l = label.toLowerCase();
        if(l.includes('email')) icon = '<i class="fa-solid fa-envelope me-1"></i>';
        if(l.includes('wa')) icon = '<i class="fa-brands fa-whatsapp me-1"></i>';
        if(l.includes('alamat')) icon = '<i class="fa-solid fa-location-dot me-1"></i>';

        const wrapper = document.createElement('div');
        wrapper.className = colClass; 
        wrapper.innerHTML = `
            <div class="detail-item">
                <div class="detail-label">${icon} ${label}</div>
                <div class="detail-value">${displayVal || '-'}</div>
            </div>
        `;
        return wrapper;
    }

    function renderPhoto(data) {
        let url = data["Upload Foto"] || "";
        if(!url) {
             for (let k in data) {
                 if (String(data[k]).includes('drive.google.com') && (k.toLowerCase().includes('foto') || k.toLowerCase().includes('upload'))) {
                     url = data[k]; break;
                 }
             }
        }
        const img = document.getElementById('detailImg');
        const msg = document.getElementById('noPhotoMsg');
        const btn = document.getElementById('btnOpenLink');
        
        if(url) {
            let cleanUrl = url;
            const parts = url.split(/\/d\/|\?id=/);
            if(parts.length > 1) {
                const id = parts[1].split('/')[0];
                cleanUrl = `https://lh3.googleusercontent.com/d/${id}=s1000?authuser=0`;
            }
            img.src = cleanUrl; img.style.display = 'inline-block'; msg.style.display = 'none'; btn.href = url;
        } else {
            img.style.display = 'none'; msg.style.display = 'block'; btn.style.display = 'none';
        }
    }

    function renderDetailStatus(data) {
        const el = document.getElementById('detailStatusBadge');
        let s = (data.Status || '').toLowerCase();
        
        if (s === 'pending') {
            el.innerHTML = '<span class="badge badge-status st-pending">Menunggu Review</span>';
        } else if (s === 'lolos' || s === 'lolos administrasi') {
            el.innerHTML = '<span class="badge badge-status st-admin"><i class="fa-solid fa-check me-1"></i> Lolos Administrasi</span>';
        } else if (s.includes('lolos wawancara')) {
            el.innerHTML = '<span class="badge badge-status st-ok"><i class="fa-solid fa-star me-1"></i> Lolos Wawancara</span>';
        } else if (s.includes('gagal')) {
            el.innerHTML = '<span class="badge badge-status st-fail">Gagal / Ditolak</span>';
        } else {
            el.innerHTML = `<span class="badge badge-status st-neu">${data.Status}</span>`;
        }
    }

    function setupActionButtons(data) {
        const footer = document.getElementById('modalFooter');
        footer.innerHTML = '<button type="button" class="btn btn-light text-muted fw-bold rounded-pill px-4" data-bs-dismiss="modal">Tutup</button>';
        
        const s = (data.Status || '').toLowerCase();
        const score = parseInt(data['Skor Wawancara']) || 0;
        
        // 1. PENDING -> LOLOS ADMIN
        if (s === 'pending') {
            const btn = document.createElement('button');
            btn.className = 'btn btn-primary ms-2 fw-bold rounded-pill px-4 shadow-sm';
            btn.innerHTML = '<i class="fa-solid fa-file-circle-check me-2"></i>Lolos Administrasi';
            btn.onclick = () => {
                 callApi('approveApplicant', data, btn);
            };
            footer.appendChild(btn);
        } 
        // 2. LOLOS ADMIN -> MENUNGGU WAWANCARA
        else if (s === 'lolos' || s === 'lolos administrasi') {
            const btn = document.createElement('button');
            btn.className = 'btn btn-secondary ms-2 fw-bold rounded-pill px-4';
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-user-clock me-2"></i>Tahap Wawancara';
            footer.appendChild(btn);
            
            const msg = document.createElement('div');
            msg.className = 'w-100 text-center mt-2 small text-muted';
            msg.innerText = '*Menunggu nilai wawancara diinput.';
            footer.parentElement.appendChild(msg);
        }
        // 3. LOLOS WAWANCARA -> GRADUATE
        else if (s.includes('lolos wawancara') && score >= MIN_SCORE) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-success ms-2 fw-bold rounded-pill px-4 shadow-sm';
            btn.innerHTML = '<i class="fa-solid fa-graduation-cap me-2"></i>Luluskan Anggota';
            btn.onclick = () => {
                if(confirm('Yakin ingin meluluskan anggota ini? Data akan dipindah.')) {
                    callApi('graduateApplicant', data, btn);
                }
            };
            footer.appendChild(btn);
        }
    }

    function callApi(action, data, btnElement) {
        if(btnElement) {
            btnElement.disabled = true;
            btnElement.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memproses...';
        }

        fetch(GAS_API_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: action,
                applicantInfo: { rowNum: data.rowNum, NamaLengkap: data["Nama Lengkap"], Email: data.Email }
            })
        })
        .then(res => res.json())
        .then(res => {
            if(res.success) { 
                showToast(res.message, 'success'); 
                detailModalBS.hide(); 
                refreshData(); 
            } else {
                throw new Error(res.message);
            }
        })
        .catch(err => {
            showToast(err.message, 'danger');
            if(btnElement) {
                btnElement.disabled = false;
                btnElement.innerText = 'Coba Lagi';
            }
        });
    }

    function showToast(msg, type) {
        const el = document.getElementById('statusMessage');
        const icon = type === 'success' ? '<i class="fa-solid fa-circle-check me-2"></i>' : '<i class="fa-solid fa-circle-exclamation me-2"></i>';
        el.className = `alert alert-${type} shadow-lg border-0 d-flex align-items-center fw-medium px-4 py-3`;
        el.innerHTML = icon + msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 4000);
    }
  </script>
</body>
</html>