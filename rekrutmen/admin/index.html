<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Rekrutmen - Sadulur Sepoor</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #004aad; /* Biru Profesional */
      --secondary-color: #f0f4f8; /* Putih Kebiruan */
      --accent-color: #002b64; /* Biru Tua */
      --text-color: #333;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--secondary-color);
      color: var(--text-color);
      font-size: 0.9rem;
    }

    /* Navbar */
    .navbar-custom {
      background-color: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 1rem 0;
    }
    .navbar-brand {
      font-weight: 600;
      color: var(--primary-color) !important;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Card Container */
    .card-dashboard {
      background: #fff;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      margin-top: 2rem;
      margin-bottom: 2rem;
    }
    
    .card-header-custom {
      background-color: #fff;
      padding: 1.5rem;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    /* Table Styling */
    .table-container {
      max-height: 75vh;
      overflow-y: auto;
    }
    
    .table-custom {
      margin-bottom: 0;
    }

    .table-custom thead th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      border: none;
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 1rem;
      white-space: nowrap;
    }

    .table-custom tbody td {
      padding: 1rem;
      vertical-align: middle;
      border-bottom: 1px solid #f0f0f0;
      color: #555;
      max-width: 250px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .table-custom tbody tr:hover {
      background-color: #f8fbff;
    }

    /* Buttons */
    .btn-refresh {
      background-color: var(--secondary-color);
      color: var(--primary-color);
      border: 1px solid transparent;
      font-weight: 500;
      padding: 0.5rem 1rem;
      transition: all 0.3s;
    }
    .btn-refresh:hover {
      background-color: var(--primary-color);
      color: #fff;
    }

    .btn-action {
      border-radius: 50px;
      font-size: 0.8rem;
      padding: 0.4rem 1rem;
      font-weight: 500;
    }

    /* Status Badges */
    .badge-custom {
      padding: 0.5em 1em;
      border-radius: 50px;
      font-weight: 500;
      font-size: 0.75rem;
      letter-spacing: 0.5px;
    }
    .bg-pending { background-color: #e3f2fd; color: #0d47a1; }
    .bg-success-soft { background-color: #e8f5e9; color: #1b5e20; }
    .bg-danger-soft { background-color: #ffebee; color: #b71c1c; }
    .bg-neutral { background-color: #f5f5f5; color: #616161; }

    /* Loading Spinner */
    .loading-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8);
      z-index: 20;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(2px);
    }

    /* Floating Alert (Toast style) */
    #statusMessage {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: none;
      min-width: 300px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .card-header-custom {
        flex-direction: column;
        align-items: flex-start;
      }
      .btn-refresh {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-custom">
    <div class="container-fluid px-4">
      <span class="navbar-brand">
        <i class="fa-solid fa-train-subway"></i>
        Admin Rekrutmen
      </span>
      <span class="text-muted small d-none d-md-block">Sadulur Sepoor Indonesia</span>
    </div>
  </nav>

  <div class="container-fluid px-lg-5">
    
    <div id="statusMessage" class="alert" style="display: none;" role="alert"></div>

    <div class="card card-dashboard position-relative">
      
      <div id="loader" class="loading-overlay">
        <div class="spinner-border text-primary mb-2" role="status" style="width: 3rem; height: 3rem;"></div>
        <span class="text-muted fw-medium">Mengambil data terbaru...</span>
      </div>

      <div class="card-header-custom">
        <div>
          <h4 class="mb-1 fw-bold text-dark">Data Pendaftar</h4>
          <p class="text-muted mb-0 small">Kelola data masuk, wawancara, dan kelulusan anggota.</p>
        </div>
        <button class="btn btn-refresh rounded-pill" onclick="refreshData()">
          <i class="fa-solid fa-rotate me-2"></i> Refresh Data
        </button>
      </div>

      <div class="table-container table-responsive">
        <table class="table table-custom table-hover" id="dataTable" style="display: none;">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // ================== PENGATURAN ==================
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwZ3u5eWEzuG0dGd7U8JL-YpJKYWtu3eyNfgNJCo2j4kvpen9dtr8uEHMY7uOLDCFSeZw/exec';
    const MINIMUM_PASSING_SCORE = 60; 

    document.addEventListener("DOMContentLoaded", () => {
      refreshData();
    });

    function refreshData() {
        const loader = document.getElementById("loader");
        const table = document.getElementById("dataTable");
        
        loader.style.display = "flex"; // Show flex overlay
        // Jangan hide table, biar tampilannya tidak 'jumpy', cukup overlay saja
        
        fetch(GAS_API_URL + '?action=getApplicants')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(res => {
                if (res.success) {
                    populateTable(res.data);
                } else {
                    throw new Error(res.message);
                }
            })
            .catch(err => showError(err))
            .finally(() => {
               loader.style.display = "none";
               table.style.display = "table";
            });
    }

    function populateTable(data) {
      const table = document.getElementById("dataTable");
      const thead = table.querySelector("thead");
      const tbody = table.querySelector("tbody");
      
      tbody.innerHTML = ''; // Clear existing
      thead.innerHTML = '';

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-5 text-muted">Belum ada data pendaftar saat ini.</td></tr>';
        return;
      }

      // Header Logic
      const headers = Object.keys(data[0]).filter(h => h !== 'rowNum');
      
      // Reorder Score & Status
      const statusIndex = headers.indexOf('Status');
      const scoreIndex = headers.indexOf('Skor Wawancara');
      if (scoreIndex > -1 && statusIndex > -1) {
          const scoreHeader = headers.splice(scoreIndex, 1)[0]; 
          headers.splice(statusIndex + 1, 0, scoreHeader); 
      }
      
      let headerHtml = '<tr>';
      headers.forEach(header => headerHtml += `<th>${header}</th>`);
      headerHtml += '<th class="text-center">Aksi</th></tr>'; 
      thead.innerHTML = headerHtml;

      // Body Logic
      let bodyHtml = '';
      data.reverse().forEach(applicant => {
        bodyHtml += `<tr id="row-${applicant.rowNum}">`;
        
        headers.forEach(header => {
          let cellValue = applicant[header];
          let cellRaw = applicant[header];
          
          // Format Link Foto
          if (typeof cellValue === 'string' && cellValue.startsWith('http')) {
            cellValue = `<a href="${cellValue}" target="_blank" class="btn btn-outline-primary btn-sm rounded-pill"><i class="fa-solid fa-image me-1"></i> Foto</a>`;
          } 
          // Format Tanggal
          else if (header.toLowerCase().includes('timestamp') && applicant[header]) {
             cellValue = new Date(applicant[header]).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
          } 
          // Format Skor
          else if (header === 'Skor Wawancara' && typeof cellValue === 'number') {
              let colorClass = cellValue >= MINIMUM_PASSING_SCORE ? 'text-success fw-bold' : 'text-danger fw-bold';
              cellValue = `<span class="${colorClass}">${cellValue}%</span>`;
          }
          // Format Status dengan Badge
          else if (header === 'Status') {
             cellValue = getStatusBadge(cellValue);
          }
          
          bodyHtml += `<td title="${cellRaw}">${cellValue}</td>`;
        });

        // ================ LOGIKA AKSI ================
        const applicantStatus = (applicant.Status || "").trim();
        const applicantScore = applicant['Skor Wawancara']; 
        const rowNum = applicant.rowNum;
        const name = applicant["Nama Lengkap"]; 
        const email = applicant.Email; 
        
        bodyHtml += '<td class="text-center">';
        const statusLower = applicantStatus.toLowerCase();

        // 1. TAHAP 1: Pendaftar Pending
        if (statusLower === 'pending') {
            bodyHtml += `<button class="btn btn-primary btn-action btn-sm shadow-sm" 
                                  id="btn-approve-${rowNum}"
                                  onclick="approveApplicantClicked(${rowNum}, '${name}', '${email}')">
                            <i class="fa-solid fa-check me-1"></i> Setujui
                          </button>`;
        } 
        // 2. TAHAP 2: Lolos Admin
        else if (statusLower === 'lolos') {
            bodyHtml += `<span class="badge bg-neutral text-dark"><i class="fa-regular fa-clock me-1"></i> Menunggu Wawancara</span>`;
        } 
        // 3. TAHAP 3: Lulus
        else if (statusLower.includes('lolos wawancara') && 
                 typeof applicantScore === 'number' && 
                 applicantScore >= MINIMUM_PASSING_SCORE) {
             bodyHtml += `<button class="btn btn-success btn-action btn-sm shadow-sm" 
                                    id="btn-graduate-${rowNum}"
                                    onclick="graduateApplicantClicked(${rowNum}, '${name}', '${email}')">
                              <i class="fa-solid fa-graduation-cap me-1"></i> Luluskan
                            </button>`;
        } 
        // 4. Gagal / Lainnya
        else {
             bodyHtml += `<span class="text-muted small">â€“</span>`;
        }
        
        bodyHtml += `</td></tr>`;
      });
      tbody.innerHTML = bodyHtml;
    }

    // Helper untuk membuat Badge Status Keren
    function getStatusBadge(statusText) {
        if (!statusText) return '<span class="badge badge-custom bg-neutral">Unknown</span>';
        
        const text = statusText.toLowerCase();
        let badgeClass = 'bg-neutral';
        let icon = '';

        if (text === 'pending') {
            badgeClass = 'bg-pending';
            icon = '<i class="fa-solid fa-hourglass-start me-1"></i>';
        } else if (text === 'lolos' || text.includes('lolos wawancara')) {
            badgeClass = 'bg-success-soft';
            icon = '<i class="fa-solid fa-check-circle me-1"></i>';
        } else if (text.includes('gagal') || text.includes('tolak')) {
            badgeClass = 'bg-danger-soft';
            icon = '<i class="fa-solid fa-circle-xmark me-1"></i>';
        }

        return `<span class="badge badge-custom ${badgeClass}">${icon}${statusText}</span>`;
    }
    
    // --- FUNGSI POST TETAP SAMA (Hanya update UI Button) ---

    function approveApplicantClicked(rowNum, name, email) {
      const btn = document.getElementById(`btn-approve-${rowNum}`);
      setBtnLoading(btn, true);

      const payload = {
          action: 'approveApplicant',
          applicantInfo: { rowNum, NamaLengkap: name, Email: email }
      };
      
      callGasPostApi(payload, 'Persetujuan administrasi berhasil.', btn);
    }

    function graduateApplicantClicked(rowNum, name, email) {
      if (!confirm(`Konfirmasi Kelulusan:\n\nNama: ${name}\n\nData akan dipindah ke database anggota tetap.`)) {
          return;
      }
        
      const btn = document.getElementById(`btn-graduate-${rowNum}`);
      setBtnLoading(btn, true);

      const payload = {
          action: 'graduateApplicant',
          applicantInfo: { rowNum, NamaLengkap: name, Email: email } 
      };
      
      callGasPostApi(payload, 'Anggota berhasil diluluskan!', btn);
    }
    
    function setBtnLoading(btn, isLoading) {
        if(isLoading) {
            btn.disabled = true;
            btn.dataset.originalText = btn.innerHTML;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Proses...`;
        } else {
            btn.disabled = false;
            btn.innerHTML = btn.dataset.originalText;
        }
    }

    function callGasPostApi(payload, successMessage, btn) {
       fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(res => {
          if (res.success) {
              showStatus(res.message, 'success');
              refreshData(); // Auto refresh
          } else {
              throw new Error(res.message);
          }
      })
      .catch(err => {
          showError(err);
          if (btn) setBtnLoading(btn, false);
      });
    }

    function showError(error) {
      let errorMessage = 'Terjadi kesalahan koneksi.';
      if (error && error.message) errorMessage = error.message;
      console.error(error);
      showStatus(errorMessage, 'danger');
    }

    function showStatus(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        const icon = type === 'success' ? '<i class="fa-solid fa-circle-check me-2"></i>' : '<i class="fa-solid fa-circle-exclamation me-2"></i>';
        
        statusDiv.className = `alert alert-${type} d-flex align-items-center border-0`;
        statusDiv.innerHTML = `${icon} <div>${message}</div>`;
        statusDiv.style.display = 'block';
        
        // Auto hide after 5 seconds
        setTimeout(() => { 
             statusDiv.style.display = 'none'; 
        }, 5000);
    }
  </script>
</body>
</html>