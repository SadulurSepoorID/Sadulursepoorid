<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Admin Rekrutmen</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-size: 0.9rem; }
    .container-fluid { padding: 2rem; }
    .table-responsive { max-height: 80vh; }
    th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
    .btn-sm { font-size: 0.75rem; padding: 0.2rem 0.5rem; }
    #loader { display: block; margin: 50px auto; }
    #dataTable { display: none; }
    td { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    /* Style untuk status di tombol aksi */
    .status-gagal { color: #dc3545; font-weight: bold; }
    .status-menunggu { color: #6c757d; font-style: italic; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0">Data Pendaftar Sadulur Sepoor</h1>
      <button class="btn btn-primary" onclick="refreshData()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
          <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
        </svg>
        Refresh Data
      </button>
    </div>
    
    <div id="statusMessage" class="alert" style="display: none;"></div>
    
    <div class="spinner-border" id="loader" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-bordered table-hover" id="dataTable">
        <thead class="table-light"></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // ================== PENGATURAN ==================
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwzWVlOwT_W-OFRWW-g9-f08WSLgLarbUlq1pbAscHSxfTUi9HeVBwznAFAupRG8cGPEg/exec';
    // ==============================================
    
    const MINIMUM_PASSING_SCORE = 60; 

    document.addEventListener("DOMContentLoaded", () => {
      refreshData();
    });

    function refreshData() {
        document.getElementById("loader").style.display = "block";
        document.getElementById("dataTable").style.display = "none";
        document.getElementById("statusMessage").style.display = "none";
        
        fetch(GAS_API_URL + '?action=getApplicants')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(res => {
                if (res.success) {
                    populateTable(res.data);
                } else {
                    throw new Error(res.message);
                }
            })
            .catch(err => showError(err));
    }

    function populateTable(data) {
      const table = document.getElementById("dataTable");
      const thead = table.querySelector("thead");
      const tbody = table.querySelector("tbody");
      
      document.getElementById("loader").style.display = "none";
      table.style.display = "table";

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100%">Belum ada data pendaftar.</td></tr>';
        return;
      }

      const headers = Object.keys(data[0]).filter(h => h !== 'rowNum');
      
      const statusIndex = headers.indexOf('Status');
      const scoreIndex = headers.indexOf('Skor Wawancara');
      if (scoreIndex > -1 && statusIndex > -1) {
          const scoreHeader = headers.splice(scoreIndex, 1)[0]; 
          headers.splice(statusIndex + 1, 0, scoreHeader); 
      }
      
      let headerHtml = '<tr>';
      headers.forEach(header => headerHtml += `<th>${header}</th>`);
      headerHtml += '<th>Aksi</th></tr>'; 
      thead.innerHTML = headerHtml;

      let bodyHtml = '';
      data.reverse().forEach(applicant => {
        bodyHtml += `<tr id="row-${applicant.rowNum}">`;
        
        headers.forEach(header => {
          let cellValue = applicant[header];
          let cellTitle = applicant[header]; 
          
          if (typeof cellValue === 'string' && cellValue.startsWith('http')) {
            cellValue = `<a href="${cellValue}" target="_blank">Lihat Foto</a>`;
          } else if (header.toLowerCase().includes('timestamp') && applicant[header]) {
             cellValue = new Date(applicant[header]).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
          } else if (header === 'Skor Wawancara' && typeof cellValue === 'number') {
              cellValue = `${cellValue}%`;
          }
          
          bodyHtml += `<td title="${cellTitle}">${cellValue}</td>`;
        });

        // ================ LOGIKA AKSI ================
        const applicantStatus = (applicant.Status || "").trim();
        const applicantScore = applicant['Skor Wawancara']; 
        const rowNum = applicant.rowNum;

        // ✅✅✅ PERBAIKAN DI SINI ✅✅✅
        // Kita harus menggunakan bracket/kurung siku ["Nama Lengkap"] karena ada spasi
        const name = applicant["Nama Lengkap"]; 
        const email = applicant.Email; // applicant.Email baik-baik saja karena tidak ada spasi
        
        bodyHtml += '<td>';
        const statusLower = applicantStatus.toLowerCase();

        // 1. TAHAP 1: Pendaftar masih "Pending"
        if (statusLower === 'pending') {
            bodyHtml += `<button class="btn btn-primary btn-sm" 
                                  id="btn-approve-${rowNum}"
                                  onclick="approveApplicantClicked(${rowNum}, '${name}', '${email}')">
                            Setujui Administrasi
                          </button>`;
        } 
        // 2. TAHAP 2: Pendaftar sudah lolos admin, tapi belum dinilai
        else if (statusLower === 'lolos') {
            bodyHtml += `<span class="status-menunggu">Menunggu Wawancara...</span>`;
        } 
        // 3. TAHAP 3: Pendaftar lolos wawancara
        else if (statusLower.includes('lolos wawancara') && 
                 typeof applicantScore === 'number' && 
                 applicantScore >= MINIMUM_PASSING_SCORE) {
             bodyHtml += `<button class="btn btn-success btn-sm" 
                                    id="btn-graduate-${rowNum}"
                                    onclick="graduateApplicantClicked(${rowNum}, '${name}', '${email}')">
                              Luluskan Anggota
                            </button>`;
        } 
        // 4. TAHAP 4: Pendaftar gagal wawancara
        else if (statusLower.includes('gagal wawancara') || 
                 (statusLower.includes('lolos wawancara') && typeof applicantScore === 'number' && applicantScore < MINIMUM_PASSING_SCORE)) {
             bodyHtml += `<span class="status-gagal">${applicantStatus}</span>`;
        } 
        // 5. Lain-lain
        else {
             bodyHtml += `<span class="status-menunggu">${applicantStatus || 'Belum ada status'}</span>`;
        }
        
        bodyHtml += `</td></tr>`;
      });
      tbody.innerHTML = bodyHtml;
    }
    
    // TAHAP 1
    function approveApplicantClicked(rowNum, name, email) {
      const btn = document.getElementById(`btn-approve-${rowNum}`);
      btn.disabled = true;
      btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Memproses...`;

      const payload = {
          action: 'approveApplicant',
          applicantInfo: { rowNum, NamaLengkap: name, Email: email }
      };
      
      callGasPostApi(payload, 'Persetujuan administrasi berhasil.', btn);
    }

    // TAHAP 3
    function graduateApplicantClicked(rowNum, name, email) {
      if (!confirm(`Apakah Anda yakin ingin MELULUSKAN ${name}?\n\nData akan dipindah ke Sheet4 dan dihapus dari daftar ini.`)) {
          return;
      }
        
      const btn = document.getElementById(`btn-graduate-${rowNum}`);
      btn.disabled = true;
      btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Memindahkan...`;

      const payload = {
          action: 'graduateApplicant',
          applicantInfo: { rowNum, NamaLengkap: name, Email: email } 
      };
      
      callGasPostApi(payload, 'Kelulusan anggota berhasil.', btn);
    }
    
    function callGasPostApi(payload, successMessage, btn) {
       fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(res => {
          if (res.success) {
              onApiSuccess(res.message);
          } else {
              throw new Error(res.message);
          }
      })
      .catch(err => {
          showError(err);
          if (btn) {
            btn.disabled = false;
            if (payload.action === 'approveApplicant') {
                btn.innerHTML = 'Setujui Administrasi';
            } else if (payload.action === 'graduateApplicant') {
                btn.innerHTML = 'Luluskan Anggota';
            } else {
                btn.innerHTML = 'Coba Lagi';
            }
          }
      });
    }

    function onApiSuccess(message) {
      showStatus(message, 'success');
      refreshData(); 
    }

    function showError(error) {
      let errorMessage = 'Terjadi kesalahan. Silakan coba lagi.';
      if (error && error.message) {
          errorMessage = error.message;
      }
      console.error(error);
      showStatus('Error: ' + errorMessage, 'danger');
      const loader = document.getElementById("loader");
      if(loader) loader.style.display = "none";
    }

    function showStatus(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.className = `alert alert-${type}`;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        window.scrollTo(0, 0); 
        setTimeout(() => { 
            if (statusDiv.textContent === message) { 
                statusDiv.style.display = 'none'; 
            }
        }, 8000);
    }
  </script>
</body>
</html>
