name: Build Android APK
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Ambil Kode
        uses: actions/checkout@v4

      - name: 2. Siapkan Java (Wajib)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: 3. Siapkan Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: 4. PERBAIKAN OTOMATIS & RAKIT ULANG
        run: |
          # 1. Buat folder kerja baru yang bersih
          mkdir rakit_app
          
          # 2. Ambil file aplikasi utama
          cp dashboard-anggota/login/index.html rakit_app/
          cp dashboard-anggota/login/style.css rakit_app/
          cp dashboard-anggota/login/script.js rakit_app/
          
          # 3. BUAT ULANG config.js (Versi Perbaikan) DI DALAM FOLDER
          # Kita perbaiki 'Const' jadi 'const' dan tambah tanda kutip penutup
          echo 'const API_URL = "https://script.google.com/macros/s/AKfycbxy4kFEmbltbIbu0InwZt1GMNCgpkzbIKZ0m5hOSFzKHNW3ULuhoglCJ1yivLTAyoUglw";' > rakit_app/config.js
          
          # 4. Patch index.html
          # Ubah <script src="../config.js"> jadi <script src="config.js">
          sed -i 's|\.\./config.js|config.js|g' rakit_app/index.html
          
          # 5. Download Ikon (Wajib ada file fisik)
          wget -O rakit_app/icon.png "https://sadulursepoor.web.id/img/Logo%20SS.png"
          
          # Cek isi folder untuk memastikan semua ada
          echo "=== ISI FOLDER FINAL ==="
          ls -R rakit_app/

      - name: 5. PROSES BUILD APK
        run: |
          cd rakit_app
          
          # Buat identitas aplikasi baru
          echo '{"name": "dss-app", "version": "1.0.0"}' > package.json
          
          # Install mesin Capacitor
          npm install @capacitor/core @capacitor/cli @capacitor/android
          
          # Inisialisasi
          npx cap init "DSS" "com.dss.app" --web-dir .
          npx cap add android
          
          # Jahit APK
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: 6. Upload Hasil APK
        uses: actions/upload-artifact@v4
        with:
          name: DSS-App-Siap-Pakai
          path: rakit_app/android/app/build/outputs/apk/debug/app-debug.apk
